<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>Admin - Rekam Wajah</title>
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    
    <style>
        body { font-family: sans-serif; text-align: center; padding: 20px; background: #f0f2f5; padding-bottom: 80px; }
        .box { background: white; padding: 20px; border-radius: 10px; display: inline-block; box-shadow: 0 4px 15px rgba(0,0,0,0.1); width: 100%; max-width: 500px; }
        video { width: 100%; border-radius: 8px; background: #000; transform: scaleX(-1); }
        label { display: block; text-align: left; font-weight: bold; margin-top: 10px; color: #555; }
        select { width: 100%; padding: 12px; margin-top: 5px; border: 1px solid #ccc; border-radius: 5px; font-size: 16px; background: #fff; }
        button { width: 100%; padding: 14px; background: #00695c; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; font-size: 16px; margin-top: 15px; }
        button:hover { background: #004d40; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        button.back { background: #6c757d; margin-bottom: 20px; width: 100%; max-width: 500px; }
        button.dl { background: #ffab00; color: black; margin-top: 20px; }
        #log { margin-top: 15px; color: green; font-weight: bold; min-height: 20px; }
        .badge-count { background: #e0f2f1; color: #00695c; padding: 5px 10px; border-radius: 15px; font-size: 12px; font-weight: bold; float: right; }
        .running-footer { position: fixed; bottom: 0; left: 0; width: 100%; background: #004d40; color: #fff; padding: 10px 0; font-size: 14px; font-weight: bold; z-index: 1000; }
    </style>
</head>
<body>

    <button class="back" onclick="location.href='admin_menu.html'">‚¨Ö Kembali ke Menu Admin</button>
    
    <div class="box">
        <h2>üé• Rekam Wajah Siswa</h2>
        <div id="loading_ai">‚è≥ Memuat AI...</div>

        <label>1. Pilih Kelas:</label>
        <select id="pilihKelas" onchange="loadSiswa()">
            <option value="">-- Menunggu Database... --</option>
        </select>

        <label>2. Pilih Nama Siswa:</label>
        <select id="pilihSiswa" disabled>
            <option value="">-- Pilih Kelas Dulu --</option>
        </select>

        <div style="margin-top: 15px; position: relative;">
            <video id="video" autoplay muted></video>
        </div>

        <button onclick="ambilSampel()" id="btnRekam" disabled>üì∏ REKAM WAJAH</button>
        
        <div id="log"></div>
        <hr style="margin: 20px 0; border: 0; border-top: 1px solid #eee;">
        
        <div style="text-align: left;">
            <span style="font-weight: bold;">Data Tersimpan:</span>
            <span id="count" class="badge-count">0 Siswa</span>
        </div>
        
        <button onclick="downloadJSON()" class="dl" id="btnDownload" disabled>üíæ DOWNLOAD JSON KELAS</button>
    </div>

    <div class="running-footer">
        <marquee direction="left" scrollamount="6">
            &copy; Layanan Digital By Halil Budiyanto, S.Kom.I
        </marquee>
    </div>

    <script>
        // --- 1. CONFIG FIREBASE ---
  const firebaseConfig = {
      apiKey: "AIzaSyBWNPcSAzQ_DC5bgXMfC6A3e2QkNMBmimw",
      authDomain: "sapamanusa.firebaseapp.com",
      projectId: "sapamanusa",
      storageBucket: "sapamanusa.firebasestorage.app",
      messagingSenderId: "1018203726618",
      appId: "1:1018203726618:web:e1715826ad005680c242a3"
  };
        
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        const MODEL_URL = 'https://justadudewhohacks.github.io/face-api.js/models';
        let descriptors = [];

        window.onload = async () => {
            try { if(sessionStorage.getItem('isAdmin') !== 'true') window.location.href="./index.html"; } catch(e){}

            // Load AI
            try {
                await Promise.all([
                    faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL),
                    faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL),
                    faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL),
                    faceapi.nets.ssdMobilenetv1.loadFromUri(MODEL_URL)
                ]);
                document.getElementById('loading_ai').style.display = 'none';
                startVideo();
            } catch (err) { alert("Gagal Load AI: " + err); }

            // Login Database & Load Kelas
            try {
                await auth.signInAnonymously();
                loadDaftarKelas();
            } catch(e) { alert("DB Error: " + e.message); }
        };

        // --- LOAD KELAS (DARI COLLECTION master_siswa) ---
        async function loadDaftarKelas() {
            const selKelas = document.getElementById('pilihKelas');
            selKelas.innerHTML = "<option>Sedang memuat data...</option>";
            
            try {
                // Ambil semua dokumen di 'master_siswa'
                const snap = await db.collection('master_siswa').get();
                
                if (snap.empty) {
                    selKelas.innerHTML = "<option value=''>Data Kosong</option>";
                    return;
                }

                let kelasList = [];
                snap.forEach(doc => {
                    // ID Dokumen adalah Nama Kelas (misal: X TE A)
                    kelasList.push(doc.id); 
                });

                selKelas.innerHTML = '<option value="">-- Pilih Kelas --</option>';
                kelasList.sort().forEach(k => {
                    let opt = document.createElement('option');
                    opt.value = k; opt.text = k;
                    selKelas.add(opt);
                });

            } catch(e) { 
                alert("Error DB: " + e.message);
                selKelas.innerHTML = "<option>Gagal Koneksi</option>";
            }
        }

        // --- LOAD SISWA (DARI DOC master_siswa/NAMAKELAS) ---
        async function loadSiswa() {
            const kelas = document.getElementById('pilihKelas').value;
            const selSiswa = document.getElementById('pilihSiswa');
            
            selSiswa.innerHTML = "<option>Memuat Siswa...</option>";
            selSiswa.disabled = true;
            document.getElementById('btnRekam').disabled = true;
            descriptors = [];
            document.getElementById('count').innerText = "0 Siswa";

            if(!kelas) return;

            try {
                // Ambil dokumen spesifik berdasarkan Nama Kelas
                const docRef = db.collection('master_siswa').doc(kelas);
                const docSnap = await docRef.get();
                
                if (!docSnap.exists) {
                    alert("Kelas tidak ditemukan!");
                    return;
                }

                // Ambil field 'list_siswa' (Array of String)
                const data = docSnap.data();
                const listSiswa = data.list_siswa || []; // Array ["ADI", "BUDI"]

                if(listSiswa.length === 0) {
                    selSiswa.innerHTML = '<option>Siswa Kosong</option>';
                    return;
                }

                selSiswa.innerHTML = '<option value="">-- Pilih Nama Siswa --</option>';
                
                // Urutkan & Tampilkan
                listSiswa.sort();
                listSiswa.forEach((nama, index) => {
                    let opt = document.createElement('option');
                    opt.value = nama; 
                    opt.text = `${index + 1}. ${nama}`; 
                    selSiswa.add(opt);
                });

                selSiswa.disabled = false;
                selSiswa.onchange = () => { 
                    document.getElementById('btnRekam').disabled = (selSiswa.value === ""); 
                };

            } catch(e) { 
                alert("Error Load Siswa: " + e.message);
            }
        }

        async function startVideo() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: {} });
                document.getElementById('video').srcObject = stream;
            } catch(e) { alert("Kamera Error: " + e); }
        }

        async function ambilSampel() {
            const nama = document.getElementById('pilihSiswa').value;
            if(!nama) return alert("Pilih Nama Siswa dulu!");

            const video = document.getElementById('video');
            const log = document.getElementById('log');
            log.innerText = "Mendeteksi wajah..."; log.style.color = "orange";

            const det = await faceapi.detectSingleFace(video, new faceapi.SsdMobilenetv1Options()).withFaceLandmarks().withFaceDescriptor();

            if (det) {
                const existingIndex = descriptors.findIndex(d => d.label === nama);
                if(existingIndex !== -1) {
                    descriptors[existingIndex] = { label: nama, descriptors: [Array.from(det.descriptor)] };
                    log.innerText = `‚úÖ Data ${nama} diperbarui!`;
                } else {
                    descriptors.push({ label: nama, descriptors: [Array.from(det.descriptor)] });
                    log.innerText = `‚úÖ Berhasil merekam: ${nama}`;
                }
                log.style.color = "green";
                document.getElementById('count').innerText = descriptors.length + " Siswa";
                document.getElementById('btnDownload').disabled = false;
                document.getElementById('pilihSiswa').value = ""; 
                document.getElementById('btnRekam').disabled = true;
            } else {
                log.innerText = "‚ùå Wajah tidak terdeteksi."; log.style.color = "red";
            }
        }

        function downloadJSON() {
            if(descriptors.length === 0) return alert("Belum ada data!");
            const kelas = document.getElementById('pilihKelas').value;
            const namaFile = kelas.replace(/\s+/g, '-') + ".json";
            const a = document.createElement('a');
            a.href = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(descriptors));
            a.download = namaFile;
            document.body.appendChild(a); a.click(); a.remove();
        }
    </script>
</body>
</html>