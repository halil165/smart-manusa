<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>Admin - Rekam Wajah</title>
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    <style>
        body { font-family: sans-serif; text-align: center; padding: 20px; background: #f0f2f5; padding-bottom: 60px; }
        .box { background: white; padding: 20px; border-radius: 10px; display: inline-block; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        video { width: 100%; max-width: 500px; border-radius: 8px; background: #000; }
        input { padding: 12px; margin: 10px; width: 300px; font-size: 16px; border: 1px solid #ddd; }
        button { padding: 12px 25px; background: #00695c; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }
        button:hover { background: #004d40; }
        button.back { background: #6c757d; margin-bottom: 20px; width:100%; max-width:500px; }
        button.dl { background: #ffab00; color: black; width: 100%; margin-top: 20px; }
        #log { margin-top: 15px; color: green; font-weight: bold; }

        .running-footer {
            position: fixed; bottom: 0; left: 0; width: 100%;
            background: #004d40; color: #fff;
            padding: 10px 0; font-size: 14px; font-weight: bold;
            z-index: 1000; box-shadow: 0 -2px 10px rgba(0,0,0,0.2);
        }
    </style>
</head>
<body>
    <button class="back" onclick="location.href='admin_menu.html'">â¬… Kembali</button>
    <h2>ðŸŽ¥ Rekam Wajah Siswa</h2>
    <div id="loading">Sedang memuat AI...</div>
    
    <div class="box" id="main-app" style="display:none;">
        <video id="video" autoplay muted></video>
        <br>
        <input type="text" id="nama" placeholder="Ketik Nama Lengkap Siswa...">
        <br>
        <button onclick="ambilSampel()">ðŸ“¸ Rekam Wajah</button>
        <div id="log"></div>
        <button onclick="downloadJSON()" class="dl">ðŸ’¾ DOWNLOAD JSON KELAS</button>
    </div>

    <div class="running-footer">
        <marquee direction="left" scrollamount="6">
            &copy; Layanan Digital By Halil Budiyanto, S.Kom.I
        </marquee>
    </div>

    <script>
        try { if(sessionStorage.getItem('isAdmin') !== 'true') window.location.href="./index.html"; } catch(e){}
        const MODEL_URL = 'https://justadudewhohacks.github.io/face-api.js/models';
        let descriptors = [];

        window.onload = async () => {
            await Promise.all([
                faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL),
                faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL),
                faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL),
                faceapi.nets.ssdMobilenetv1.loadFromUri(MODEL_URL)
            ]);
            document.getElementById('loading').style.display = 'none';
            document.getElementById('main-app').style.display = 'inline-block';
            navigator.mediaDevices.getUserMedia({ video: {} }).then(s => document.getElementById('video').srcObject = s);
        };

        async function ambilSampel() {
            const nama = document.getElementById('nama').value.trim();
            if(!nama) return alert("Isi Nama!");
            const video = document.getElementById('video');
            document.getElementById('log').innerText = "Mendeteksi...";
            
            const det = await faceapi.detectSingleFace(video, new faceapi.SsdMobilenetv1Options()).withFaceLandmarks().withFaceDescriptor();
            if (det) {
                descriptors.push({ label: nama, descriptors: [Array.from(det.descriptor)] });
                document.getElementById('log').innerText = `âœ… Tersimpan: ${nama} (Total: ${descriptors.length})`;
                document.getElementById('nama').value = ""; document.getElementById('nama').focus();
            } else { alert("Wajah tidak terdeteksi!"); }
        }

        function downloadJSON() {
            if(descriptors.length === 0) return alert("Belum ada data!");
            const namaKelas = prompt("Nama File (Tanpa Spasi, cth: X-IPA-1):", "X-IPA-1");
            if(!namaKelas) return;
            const a = document.createElement('a');
            a.href = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(descriptors));
            a.download = namaKelas + ".json";
            a.click();
        }
    </script>
</body>
</html>