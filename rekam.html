<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>Admin - Rekam Wajah</title>
    <!-- Library AI & Firebase -->
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    
    <style>
        body { font-family: sans-serif; text-align: center; padding: 20px; background: #f0f2f5; padding-bottom: 80px; }
        .box { background: white; padding: 20px; border-radius: 10px; display: inline-block; box-shadow: 0 4px 15px rgba(0,0,0,0.1); width: 100%; max-width: 500px; }
        
        video { width: 100%; border-radius: 8px; background: #000; transform: scaleX(-1); }
        
        label { display: block; text-align: left; font-weight: bold; margin-top: 10px; color: #555; }
        select { width: 100%; padding: 12px; margin-top: 5px; border: 1px solid #ccc; border-radius: 5px; font-size: 16px; background: #fff; }
        
        button { width: 100%; padding: 14px; background: #00695c; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; font-size: 16px; margin-top: 15px; }
        button:hover { background: #004d40; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        
        button.back { background: #6c757d; margin-bottom: 20px; width: 100%; max-width: 500px; }
        button.dl { background: #ffab00; color: black; margin-top: 20px; }
        
        #log { margin-top: 15px; color: green; font-weight: bold; min-height: 20px; }
        .badge-count { background: #e0f2f1; color: #00695c; padding: 5px 10px; border-radius: 15px; font-size: 12px; font-weight: bold; float: right; }
        
        /* Area Status Error */
        #dbStatus { color: red; font-size: 12px; margin-top: 5px; font-weight: bold; display:none; background: #ffebee; padding: 5px; border-radius: 4px; }
        
        .running-footer {
            position: fixed; bottom: 0; left: 0; width: 100%;
            background: #004d40; color: #fff;
            padding: 10px 0; font-size: 14px; font-weight: bold;
            z-index: 1000; box-shadow: 0 -2px 10px rgba(0,0,0,0.2);
        }
    </style>
</head>
<body>

    <button class="back" onclick="location.href='admin_menu.html'">‚¨Ö Kembali ke Menu Admin</button>
    
    <div class="box">
        <h2>üé• Rekam Wajah Siswa</h2>
        <div id="loading_ai">‚è≥ Memuat AI...</div>

        <!-- AREA DETEKSI ERROR -->
        <div id="dbStatus"></div>

        <!-- PILIHAN KELAS -->
        <label>1. Pilih Kelas:</label>
        <select id="pilihKelas" onchange="loadSiswa()">
            <option value="">-- Menunggu Database... --</option>
        </select>

        <label>2. Pilih Nama Siswa:</label>
        <select id="pilihSiswa" disabled>
            <option value="">-- Pilih Kelas Dulu --</option>
        </select>

        <!-- VIDEO AREA -->
        <div style="margin-top: 15px; position: relative;">
            <video id="video" autoplay muted></video>
        </div>

        <button onclick="ambilSampel()" id="btnRekam" disabled>üì∏ REKAM WAJAH</button>
        
        <div id="log"></div>
        <hr style="margin: 20px 0; border: 0; border-top: 1px solid #eee;">
        
        <div style="text-align: left;">
            <span style="font-weight: bold;">Data Tersimpan:</span>
            <span id="count" class="badge-count">0 Siswa</span>
        </div>
        
        <button onclick="downloadJSON()" class="dl" id="btnDownload" disabled>üíæ DOWNLOAD JSON KELAS</button>
    </div>

    <!-- FOOTER -->
    <div class="running-footer">
        <marquee direction="left" scrollamount="6">
            &copy; Layanan Digital By Halil Budiyanto, S.Kom.I
        </marquee>
    </div>

    <script>
        // --- 1. CONFIG FIREBASE (WAJIB DIGANTI) ---
  const firebaseConfig = {
      apiKey: "AIzaSyBWNPcSAzQ_DC5bgXMfC6A3e2QkNMBmimw",
      authDomain: "sapamanusa.firebaseapp.com",
      projectId: "sapamanusa",
      storageBucket: "sapamanusa.firebasestorage.app",
      messagingSenderId: "1018203726618",
      appId: "1:1018203726618:web:e1715826ad005680c242a3"
  };
        
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        const MODEL_URL = 'https://justadudewhohacks.github.io/face-api.js/models';
        let descriptors = [];

        window.onload = async () => {
            // Cek Login Admin
            try { if(sessionStorage.getItem('isAdmin') !== 'true') window.location.href="./index.html"; } catch(e){}

            // Load AI
            try {
                await Promise.all([
                    faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL),
                    faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL),
                    faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL),
                    faceapi.nets.ssdMobilenetv1.loadFromUri(MODEL_URL)
                ]);
                document.getElementById('loading_ai').style.display = 'none';
                startVideo();
            } catch (err) { alert("Gagal Load AI: " + err); }

            // Login Anonim & Load Kelas
            try {
                await auth.signInAnonymously();
                loadDaftarKelas();
            } catch(e) { 
                showError("Gagal Login Database: " + e.message);
            }
        };

        function showError(msg) {
            const el = document.getElementById('dbStatus');
            el.innerText = msg;
            el.style.display = 'block';
        }

        // --- FUNGSI LOAD KELAS (Dari master_siswa) ---
        async function loadDaftarKelas() {
            const selKelas = document.getElementById('pilihKelas');
            selKelas.innerHTML = "<option>Sedang memuat data...</option>";
            
            try {
                // Ambil semua dokumen di master_siswa
                const snap = await db.collection('master_siswa').limit(200).get();
                
                if (snap.empty) {
                    showError("‚ö† Koleksi 'master_siswa' KOSONG. Cek Firebase Console.");
                    selKelas.innerHTML = "<option value=''>Data Kosong</option>";
                    return;
                }

                let kelasUnik = new Set();
                let fieldFound = false;

                snap.forEach(doc => {
                    const data = doc.data();
                    
                    // Cek berbagai kemungkinan nama field untuk kelas
                    if(data.kelas) { kelasUnik.add(data.kelas); fieldFound = true; }
                    else if(data.nama_kelas) { kelasUnik.add(data.nama_kelas); fieldFound = true; }
                    else if(data.rombel) { kelasUnik.add(data.rombel); fieldFound = true; }
                    else {
                        // Jika tidak ada field khusus, gunakan ID Dokumen sebagai Nama Kelas
                        // Contoh: dokumen bernama "X E 1"
                        kelasUnik.add(doc.id); 
                        fieldFound = true;
                    }
                });

                if(!fieldFound) {
                    showError("‚ö† Format data kelas tidak dikenali.");
                    selKelas.innerHTML = "<option value=''>Format Salah</option>";
                    return;
                }

                // Masukkan ke Dropdown
                selKelas.innerHTML = '<option value="">-- Pilih Kelas --</option>';
                const sorted = Array.from(kelasUnik).sort();
                
                sorted.forEach(k => {
                    let opt = document.createElement('option');
                    opt.value = k; opt.text = k;
                    selKelas.add(opt);
                });
                document.getElementById('dbStatus').style.display = 'none';

            } catch(e) { 
                showError("‚õî Error Database: " + e.message);
                selKelas.innerHTML = "<option>Gagal Koneksi</option>";
            }
        }

        // --- FUNGSI LOAD SISWA (Tanpa NIS, Dari list_siswa) ---
        async function loadSiswa() {
            const kelas = document.getElementById('pilihKelas').value;
            const selSiswa = document.getElementById('pilihSiswa');
            const btnRekam = document.getElementById('btnRekam');
            const btnDL = document.getElementById('btnDownload');

            selSiswa.innerHTML = "<option>Memuat Siswa...</option>";
            selSiswa.disabled = true;
            btnRekam.disabled = true;
            
            descriptors = [];
            document.getElementById('count').innerText = "0 Siswa";
            btnDL.disabled = true;

            if(!kelas) return;

            try {
                // Filter berdasarkan kelas
                const snap = await db.collection('list_siswa')
                                     .where('kelas', '==', kelas)
                                     .get();
                
                selSiswa.innerHTML = '<option value="">-- Pilih Nama Siswa --</option>';
                
                if(snap.empty) {
                    showError(`Tidak ada siswa di kelas ${kelas}.`);
                    selSiswa.innerHTML = '<option>Siswa Kosong</option>';
                    return;
                }

                let siswaList = [];
                snap.forEach(doc => {
                    const d = doc.data();
                    // Ambil field 'nama' atau 'nama_lengkap' atau 'nama_siswa'
                    const namaSiswa = d.nama || d.nama_lengkap || d.nama_siswa || "Tanpa Nama";
                    siswaList.push(namaSiswa);
                });
                
                // Urutkan Nama A-Z
                siswaList.sort();

                siswaList.forEach(nama => {
                    let opt = document.createElement('option');
                    opt.value = nama; 
                    opt.text = nama;
                    selSiswa.add(opt);
                });

                selSiswa.disabled = false;
                selSiswa.onchange = () => { btnRekam.disabled = (selSiswa.value === ""); };
                document.getElementById('dbStatus').style.display = 'none';

            } catch(e) { 
                showError("Gagal ambil siswa: " + e.message);
                // Jika error index, beritahu cara fix-nya
                if(e.message.includes("index")) alert("‚ö†Ô∏è ERROR INDEX: Buka link di Console (F12) untuk membuat index Firebase.");
            }
        }

        async function startVideo() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: {} });
                document.getElementById('video').srcObject = stream;
            } catch(e) { alert("Kamera Error: " + e); }
        }

        async function ambilSampel() {
            const nama = document.getElementById('pilihSiswa').value;
            if(!nama) return alert("Pilih Nama Siswa dulu!");

            const video = document.getElementById('video');
            const log = document.getElementById('log');
            log.innerText = "Mendeteksi wajah..."; log.style.color = "orange";

            // Deteksi Wajah
            const det = await faceapi.detectSingleFace(video, new faceapi.SsdMobilenetv1Options()).withFaceLandmarks().withFaceDescriptor();

            if (det) {
                // Simpan data wajah (Label = Nama Langsung)
                const existingIndex = descriptors.findIndex(d => d.label === nama);
                
                if(existingIndex !== -1) {
                    descriptors[existingIndex] = { label: nama, descriptors: [Array.from(det.descriptor)] };
                    log.innerText = `‚úÖ Data ${nama} diperbarui!`;
                } else {
                    descriptors.push({ label: nama, descriptors: [Array.from(det.descriptor)] });
                    log.innerText = `‚úÖ Berhasil merekam: ${nama}`;
                }
                
                log.style.color = "green";
                document.getElementById('count').innerText = descriptors.length + " Siswa";
                document.getElementById('btnDownload').disabled = false;
                
                // Reset (Agar bisa pilih siswa lain)
                document.getElementById('pilihSiswa').value = "";
                document.getElementById('btnRekam').disabled = true;

            } else {
                log.innerText = "‚ùå Wajah tidak terdeteksi."; log.style.color = "red";
            }
        }

        function downloadJSON() {
            if(descriptors.length === 0) return alert("Belum ada data!");
            
            const kelas = document.getElementById('pilihKelas').value;
            // Format Nama File: X-E-1.json (Ganti spasi dengan strip)
            const namaFile = kelas.replace(/\s+/g, '-') + ".json";

            const a = document.createElement('a');
            a.href = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(descriptors));
            a.download = namaFile;
            document.body.appendChild(a); a.click(); a.remove();
        }
    </script>
</body>
</html>