<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>Admin - Kelola Wajah</title>
    <!-- Library AI & Firebase -->
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        body { font-family: 'Segoe UI', sans-serif; text-align: center; padding: 20px; background: #f0f2f5; padding-bottom: 80px; }
        .container { max-width: 800px; margin: 0 auto; }
        
        .box { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); margin-bottom: 20px; }
        
        video { width: 100%; max-width: 400px; border-radius: 8px; background: #000; transform: scaleX(-1); border: 3px solid #ddd; }
        
        label { display: block; text-align: left; font-weight: bold; margin-top: 10px; color: #555; }
        select { width: 100%; padding: 12px; margin-top: 5px; border: 1px solid #ccc; border-radius: 6px; font-size: 16px; background: #fff; }
        
        button { width: 100%; padding: 14px; background: #00695c; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 16px; margin-top: 15px; transition: 0.3s; }
        button:hover { background: #004d40; transform: translateY(-2px); }
        button:disabled { background: #ccc; cursor: not-allowed; transform: none; }
        
        .btn-back { background: #546e7a; margin-bottom: 15px; width: auto; padding: 10px 20px; float: left; }
        .btn-del { background: #d32f2f; padding: 5px 10px; font-size: 12px; width: auto; margin: 0; }
        
        #log { margin-top: 10px; font-weight: bold; min-height: 20px; }
        
        /* Tabel Data Wajah */
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { padding: 10px; border-bottom: 1px solid #eee; text-align: left; }
        th { background: #e0f2f1; color: #00695c; }
        
        .running-footer { position: fixed; bottom: 0; left: 0; width: 100%; background: #004d40; color: #fff; padding: 10px 0; font-size: 14px; font-weight: bold; z-index: 1000; }
    </style>
</head>
<body>

<div class="container">
    <button class="btn-back" onclick="location.href='admin_menu.html'">‚¨Ö Menu Admin</button>
    <div style="clear:both;"></div>

    <!-- AREA REKAM -->
    <div class="box">
        <h2 style="margin-top:0; color:#00695c;">üé• Rekam Wajah Otomatis</h2>
        <div id="loading_ai">‚è≥ Memuat AI...</div>
        <div id="dbStatus" style="color:red; display:none;"></div>

        <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 10px; text-align: left;">
            <div>
                <label>1. Pilih Kelas:</label>
                <select id="pilihKelas" onchange="gantiKelas()">
                    <option value="">-- Loading... --</option>
                </select>
            </div>
            <div>
                <label>2. Pilih Siswa:</label>
                <select id="pilihSiswa" disabled>
                    <option value="">-- Pilih Kelas Dulu --</option>
                </select>
            </div>
        </div>

        <div style="margin-top: 15px;">
            <video id="video" autoplay muted></video>
        </div>

        <button onclick="ambilSampel()" id="btnRekam" disabled>üì∏ REKAM & SIMPAN OTOMATIS</button>
        <div id="log"></div>
    </div>

    <!-- AREA LIST DATA -->
    <div class="box">
        <h3 style="margin:0; color:#00695c; display:flex; justify-content:space-between;">
            <span>üìÇ Data Wajah Tersimpan</span>
            <span id="jmlData" style="font-size:14px; background:#b2dfdb; padding:2px 8px; border-radius:10px;">0 Siswa</span>
        </h3>
        <p style="font-size:12px; color:#666; margin-bottom:10px;">Data ini langsung tersimpan di Cloud Database.</p>
        
        <table id="tabelWajah">
            <thead>
                <tr>
                    <th>No</th>
                    <th>Nama Siswa</th>
                    <th>Aksi</th>
                </tr>
            </thead>
            <tbody>
                <tr><td colspan="3" style="text-align:center;">Belum ada data wajah di kelas ini.</td></tr>
            </tbody>
        </table>
    </div>
</div>

<div class="running-footer">
    <marquee direction="left" scrollamount="6">&copy; Layanan Digital By Halil Budiyanto, S.Kom.I</marquee>
</div>

<script>
    // --- 1. CONFIG FIREBASE (WAJIB GANTI) ---
  const firebaseConfig = {
      apiKey: "AIzaSyBWNPcSAzQ_DC5bgXMfC6A3e2QkNMBmimw",
      authDomain: "sapamanusa.firebaseapp.com",
      projectId: "sapamanusa",
      storageBucket: "sapamanusa.firebasestorage.app",
      messagingSenderId: "1018203726618",
      appId: "1:1018203726618:web:e1715826ad005680c242a3"
  };
    
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    const MODEL_URL = 'https://justadudewhohacks.github.io/face-api.js/models';
    let dataWajahKelas = []; // Menyimpan data wajah lokal sementara

    // --- 2. INITIALIZE ---
    window.onload = async () => {
        try { if(sessionStorage.getItem('isAdmin') !== 'true') window.location.href="./index.html"; } catch(e){}

        // Load AI
        try {
            await Promise.all([
                faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL),
                faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL),
                faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL),
                faceapi.nets.ssdMobilenetv1.loadFromUri(MODEL_URL)
            ]);
            document.getElementById('loading_ai').style.display = 'none';
            startVideo();
        } catch (err) { alert("Gagal Load AI: " + err); }

        // Login DB
        try {
            await auth.signInAnonymously();
            loadDaftarKelas();
        } catch(e) { document.getElementById('dbStatus').innerText = "DB Error: " + e.message; }
    };

    // --- 3. LOGIKA LOAD DATA ---
    async function loadDaftarKelas() {
        // Sama seperti sebelumnya, load dari master_siswa
        const selKelas = document.getElementById('pilihKelas');
        try {
            const snap = await db.collection('master_siswa').limit(200).get();
            let kelasList = [];
            snap.forEach(doc => kelasList.push(doc.id)); // ID Dokumen = Nama Kelas
            
            selKelas.innerHTML = '<option value="">-- Pilih Kelas --</option>';
            kelasList.sort().forEach(k => {
                selKelas.add(new Option(k, k));
            });
        } catch(e) { alert("Gagal load kelas"); }
    }

    async function gantiKelas() {
        const kelas = document.getElementById('pilihKelas').value;
        const selSiswa = document.getElementById('pilihSiswa');
        
        selSiswa.innerHTML = "<option>Memuat...</option>";
        selSiswa.disabled = true;
        document.getElementById('btnRekam').disabled = true;

        if(!kelas) return;

        // 1. Load Daftar Nama Siswa (Dropdown)
        try {
            const docRef = db.collection('master_siswa').doc(kelas);
            const docSnap = await docRef.get();
            
            selSiswa.innerHTML = '<option value="">-- Pilih Nama --</option>';
            if(docSnap.exists) {
                const list = docSnap.data().list_siswa || [];
                list.sort().forEach((nama, idx) => {
                    selSiswa.add(new Option(`${idx+1}. ${nama}`, nama));
                });
                selSiswa.disabled = false;
            }
        } catch(e) { console.error(e); }

        // 2. Load Data Wajah yang SUDAH TERSIMPAN (Untuk Tabel)
        loadDataWajahTersimpan(kelas);
    }

    // --- 4. CRUD FIRESTORE (INTI FITUR BARU) ---
    async function loadDataWajahTersimpan(kelas) {
        const tbody = document.querySelector('#tabelWajah tbody');
        tbody.innerHTML = "<tr><td colspan='3'>Mengambil data...</td></tr>";
        
        try {
            const docRef = db.collection('data_wajah').doc(kelas);
            const docSnap = await docRef.get();

            if (docSnap.exists && docSnap.data().faces) {
                // Simpan ke variabel global
                dataWajahKelas = docSnap.data().faces; 
            } else {
                dataWajahKelas = [];
            }
            renderTabel();

        } catch (e) {
            tbody.innerHTML = `<tr><td colspan='3' style='color:red'>Error: ${e.message}</td></tr>`;
        }
    }

    function renderTabel() {
        const tbody = document.querySelector('#tabelWajah tbody');
        const count = document.getElementById('jmlData');
        
        tbody.innerHTML = "";
        count.innerText = dataWajahKelas.length + " Siswa";

        if(dataWajahKelas.length === 0) {
            tbody.innerHTML = "<tr><td colspan='3' style='text-align:center; color:#999;'>Belum ada data wajah tersimpan.</td></tr>";
            return;
        }

        // Urutkan berdasarkan nama
        dataWajahKelas.sort((a, b) => a.label.localeCompare(b.label));

        dataWajahKelas.forEach((item, index) => {
            const row = `
                <tr>
                    <td>${index + 1}</td>
                    <td><b>${item.label}</b></td>
                    <td>
                        <button class="btn-del" onclick="hapusWajah('${item.label}')">
                            <i class="fa-solid fa-trash"></i> Hapus
                        </button>
                    </td>
                </tr>
            `;
            tbody.innerHTML += row;
        });
    }

    // --- 5. LOGIKA REKAM & SIMPAN OTOMATIS (FIX: NESTED ARRAY) ---
    async function ambilSampel() {
        const nama = document.getElementById('pilihSiswa').value;
        const kelas = document.getElementById('pilihKelas').value;
        const btn = document.getElementById('btnRekam');
        const log = document.getElementById('log');

        if(!nama || !kelas) return alert("Pilih Kelas dan Siswa!");

        log.innerText = "Mendeteksi..."; log.style.color = "orange";
        btn.disabled = true;

        const video = document.getElementById('video');
        const det = await faceapi.detectSingleFace(video, new faceapi.SsdMobilenetv1Options()).withFaceLandmarks().withFaceDescriptor();

        if (det) {
            log.innerText = "Menyimpan ke Cloud...";
            
            // Konversi Float32Array ke Array biasa (wajib untuk Firestore)
            const descriptorArray = Array.from(det.descriptor);

            // Cek apakah siswa sudah ada? Update jika ada
            const existingIndex = dataWajahKelas.findIndex(d => d.label === nama);
            if(existingIndex !== -1) {
                // Update data lama (Timpa descriptors dengan array baru yang dibungkus array)
                // PENTING: Firestore tidak suka array of arrays [[1,2,3]]. 
                // Kita akan simpan sebagai object atau serialisasikan jika perlu.
                // Tapi untuk face-api, kita butuh array of arrays.
                // SOLUSI: Bungkus descriptorArray ke dalam object atau array biasa.
                // Untuk simplisitas dan kompatibilitas dengan scanner, kita simpan:
                // descriptors: [descriptorArray] <- Ini nested array [Array(128)].
                // Firestore MEMBOLEHKAN array of arrays JIKA array dalamnya bukan array primitive tapi List object.
                // Tapi cara paling aman: JSON.stringify array dalamnya. 
                // ATAU: Ubah struktur penyimpanan.
                
                // ALTERNATIF AMAN: Kita simpan sebagai array biasa.
                dataWajahKelas[existingIndex] = { 
                    label: nama, 
                    descriptors: JSON.stringify([descriptorArray]) // Serialize ke String agar aman
                };
            } else {
                dataWajahKelas.push({ 
                    label: nama, 
                    descriptors: JSON.stringify([descriptorArray]) // Serialize ke String agar aman
                });
            }

            // SIMPAN KE FIRESTORE
            try {
                await db.collection('data_wajah').doc(kelas).set({
                    faces: dataWajahKelas, // Simpan array lengkap
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                log.innerText = `‚úÖ SUKSES: ${nama} tersimpan!`;
                log.style.color = "green";
                renderTabel(); // Update tabel UI
                
                // Reset input
                document.getElementById('pilihSiswa').value = "";

            } catch(e) {
                log.innerText = "‚ùå Gagal Simpan: " + e.message;
                log.style.color = "red";
                console.error(e);
            }

        } else {
            log.innerText = "‚ùå Wajah tidak terdeteksi."; log.style.color = "red";
        }
        btn.disabled = false; // Aktifkan lagi tombolnya
    }

    // --- 6. FUNGSI HAPUS ---
    async function hapusWajah(nama) {
        const kelas = document.getElementById('pilihKelas').value;
        if(!confirm(`Yakin ingin menghapus data wajah: ${nama}?`)) return;

        // Hapus dari array lokal
        dataWajahKelas = dataWajahKelas.filter(item => item.label !== nama);

        // Update ke Firestore
        try {
            await db.collection('data_wajah').doc(kelas).set({
                faces: dataWajahKelas,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            renderTabel();
            alert("Data berhasil dihapus.");
        } catch(e) {
            alert("Gagal menghapus: " + e.message);
        }
    }

    // Aktifkan tombol rekam jika siswa dipilih
    document.getElementById('pilihSiswa').onchange = function() {
        document.getElementById('btnRekam').disabled = (this.value === "");
    };

    async function startVideo() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ video: {} });
            document.getElementById('video').srcObject = stream;
        } catch(e) { alert("Kamera Error: " + e); }
    }
</script>
</body>
</html>