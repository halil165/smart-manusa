<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Atur Kode</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script> 
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <style>
        body { font-family: sans-serif; background: #f4f6f8; padding: 20px; max-width: 800px; margin: auto; padding-bottom: 60px; }
        .card { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 20px; }
        label { font-weight: bold; display: block; margin-top: 10px; font-size: 14px; color: #555; }
        select, input { width: 100%; padding: 10px; margin-top: 5px; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box; }
        
        button { width: 100%; padding: 12px; background: #00695c; color: white; border: none; border-radius: 5px; margin-top: 15px; cursor: pointer; font-weight: bold; }
        button:hover { background: #004d40; }
        
        .btn-check { background: #ff9800; color: black; margin-top: 5px; }
        
        button.back { background: #6c757d; width: auto; margin-bottom: 10px;}
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { padding: 10px; border-bottom: 1px solid #eee; text-align: left; }
        th { background: #e0f2f1; color: #00695c;}
        .badge { background: #ffab00; color: #000; padding: 2px 8px; border-radius: 10px; font-size: 12px; font-weight: bold; }
        
        #debugLog { 
            background: #212121; color: #00e676; 
            padding: 15px; margin-top: 10px; 
            border-radius: 5px; font-family: monospace; font-size: 12px;
            display: none; line-height: 1.5;
        }
        .running-footer {
            position: fixed; bottom: 0; left: 0; width: 100%;
            background: #004d40; color: #fff;
            padding: 10px 0; font-size: 14px; font-weight: bold;
            z-index: 1000; box-shadow: 0 -2px 10px rgba(0,0,0,0.2);
        }
    </style>
</head>
<body>
    <button class="back" onclick="goBack()">‚¨Ö Kembali</button>
    <div id="authStatus" style="float:right; font-size:12px; font-weight:bold; color:#666;">Auth...</div>
    <h2>‚öôÔ∏è Atur Kode Akses</h2>

    <!-- AREA DIAGNOSIS DATABASE -->
    <div class="card" style="border-left: 5px solid #ff9800;">
        <h3>üõ† Sumber Data Kelas</h3>
        <p style="font-size: 12px; color: #666;">Mengambil daftar kelas dari Master Data.</p>
        
        <div style="display: flex; gap: 10px;">
            <div style="flex: 1;">
                <label>Nama Collection:</label>
                <!-- Default diubah ke master_siswa -->
                <input type="text" id="inputColl" value="master_siswa" placeholder="cth: master_siswa">
            </div>
            <div style="flex: 1;">
                <label>Nama Field Kelas:</label>
                <!-- Default field pencarian -->
                <input type="text" id="inputField" value="kelas" placeholder="cth: kelas">
            </div>
        </div>
        <button class="btn-check" onclick="loadDaftarKelas()">üîÑ MUAT DATA KELAS</button>
        
        <div id="debugLog"></div>
    </div>

    <!-- AREA INPUT UTAMA -->
    <div class="card">
        <h3>1. Buat Kode Baru</h3>
        <label>Pilih Kelas:</label>
        <select id="pilihKelas"><option value="">-- Klik Tombol Oranye di Atas --</option></select>

        <label>Set Kode Akses Unik:</label>
        <input type="text" id="inputKode" placeholder="Contoh: XIPA1" onkeyup="this.value = this.value.toUpperCase()">
        <button onclick="simpanKode()">üíæ SIMPAN KODE</button>
    </div>

    <div class="card">
        <h3>2. Daftar Kode Aktif</h3>
        <table id="tabelData"></table>
    </div>

    <div class="running-footer">
        <marquee direction="left" scrollamount="6">
            &copy; Layanan Digital By Halil Budiyanto, S.Kom.I
        </marquee>
    </div>

    <script>
        // --- CONFIG FIREBASE (PASTIKAN SUDAH BENAR) ---
  const firebaseConfig = {
      apiKey: "AIzaSyBWNPcSAzQ_DC5bgXMfC6A3e2QkNMBmimw",
      authDomain: "sapamanusa.firebaseapp.com",
      projectId: "sapamanusa",
      storageBucket: "sapamanusa.firebasestorage.app",
      messagingSenderId: "1018203726618",
      appId: "1:1018203726618:web:e1715826ad005680c242a3"
  };
        
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        function goBack() { try { window.location.href = "./admin_menu.html"; } catch(e) { alert("Back Error"); } }

        window.onload = async () => {
            try { if(sessionStorage.getItem('isAdmin') !== 'true') window.location.href="./index.html"; } catch(e){}
            
            // Login Anonim Otomatis
            auth.onAuthStateChanged(user => {
                const st = document.getElementById('authStatus');
                if(user) {
                    st.innerText = "‚úÖ Database Connected"; st.style.color = "green";
                    setupRealtimeListener();
                } else {
                    st.innerText = "üîÑ Connecting...";
                    auth.signInAnonymously().catch(e => alert(e.message));
                }
            });
        };

        // --- FUNGSI LOAD KELAS DARI MASTER_SISWA ---
        async function loadDaftarKelas() {
            const select = document.getElementById('pilihKelas');
            const debugLog = document.getElementById('debugLog');
            
            let collName = document.getElementById('inputColl').value.trim();
            let fieldName = document.getElementById('inputField').value.trim();

            debugLog.style.display = 'block';
            debugLog.innerHTML = `‚è≥ Membaca collection: <b>'${collName}'</b>...`;
            debugLog.style.color = "#fff";
            select.innerHTML = '<option>Sedang memuat...</option>';

            try {
                // Ambil data dari master_siswa
                const snap = await db.collection(collName).limit(100).get(); 
                
                if (snap.empty) {
                    debugLog.innerHTML += `<br>‚ùå GAGAL: Collection '${collName}' tidak ditemukan atau kosong.`;
                    select.innerHTML = '<option>Data Kosong</option>';
                    return;
                }

                debugLog.innerHTML += `<br>‚úÖ Ditemukan ${snap.size} data master.`;
                
                let kelasUnik = new Set();
                
                snap.forEach(doc => { 
                    const data = doc.data();
                    // Cek berbagai kemungkinan nama field untuk kelas
                    let namaKelas = data[fieldName] || data['nama_kelas'] || data['kelas'] || data['id'] || doc.id;
                    
                    if (namaKelas) {
                        kelasUnik.add(namaKelas);
                    }
                });

                // Urutkan dan Tampilkan
                select.innerHTML = '<option value="">-- Pilih Kelas --</option>';
                const sortedKelas = Array.from(kelasUnik).sort();
                
                sortedKelas.forEach(k => {
                    select.innerHTML += `<option value="${k}">${k}</option>`;
                });

                debugLog.innerHTML += `<br>‚úÖ SUKSES LOAD ${sortedKelas.length} KELAS.`;
                debugLog.style.color = "#00e676";

            } catch(e) { 
                debugLog.style.color = "#ff5252";
                debugLog.innerHTML += `<br>‚õî ERROR: ${e.message}`;
            }
        }

        async function simpanKode() {
            const kelas = document.getElementById('pilihKelas').value;
            const kode = document.getElementById('inputKode').value.trim();
            if(!kelas || !kode) return alert("Pilih Kelas dan isi Kode!");
            
            try {
                const cek = await db.collection('akses_kelas').where('kode','==',kode).get();
                if(!cek.empty) return alert("Kode sudah dipakai!");

                // Simpan mapping Kode -> Nama Kelas
                await db.collection('akses_kelas').doc(kelas.replace(/\s+/g,'_')).set({
                    nama_kelas: kelas, 
                    kode: kode, 
                    updated: firebase.firestore.FieldValue.serverTimestamp()
                });
                alert("‚úÖ Kode Berhasil Disimpan!"); 
                document.getElementById('inputKode').value = "";
            } catch(e) {
                alert("Gagal Simpan: " + e.message);
            }
        }

        function setupRealtimeListener() {
            db.collection('akses_kelas').onSnapshot(snap => {
                let html = "<tr><th>Kelas</th><th>Kode</th><th>Aksi</th></tr>";
                snap.forEach(doc => {
                    const d = doc.data();
                    html += `<tr><td><b>${d.nama_kelas}</b></td><td><span class="badge">${d.kode}</span></td><td><button style="width:auto; padding:5px; background:red; margin:0;" onclick="hapus('${doc.id}')">Hapus</button></td></tr>`;
                });
                document.getElementById('tabelData').innerHTML = html;
            });
        }

        window.hapus = async (id) => { if(confirm("Hapus?")) await db.collection('akses_kelas').doc(id).delete(); }
    </script>
</body>
</html>