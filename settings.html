<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Atur Kode</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script> 
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <style>
        body { font-family: sans-serif; background: #f4f6f8; padding: 20px; max-width: 800px; margin: auto; padding-bottom: 60px; }
        .card { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 20px; }
        label { font-weight: bold; display: block; margin-top: 10px; font-size: 14px; color: #555; }
        select, input { width: 100%; padding: 10px; margin-top: 5px; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box; }
        
        button { width: 100%; padding: 12px; background: #00695c; color: white; border: none; border-radius: 5px; margin-top: 15px; cursor: pointer; font-weight: bold; }
        button:hover { background: #004d40; }
        
        .btn-check { background: #ff9800; color: black; margin-top: 5px; }
        
        button.back { background: #6c757d; width: auto; margin-bottom: 10px;}
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { padding: 10px; border-bottom: 1px solid #eee; text-align: left; }
        th { background: #e0f2f1; color: #00695c;}
        .badge { background: #ffab00; color: #000; padding: 2px 8px; border-radius: 10px; font-size: 12px; font-weight: bold; }
        
        /* Area Pesan Error */
        #debugLog { 
            background: #263238; color: #ff5252; 
            padding: 15px; margin-top: 10px; 
            border-radius: 5px; font-family: monospace; font-size: 12px;
            display: none; line-height: 1.5;
        }
        .code-snippet { background: #000; color: #00e676; padding: 2px 5px; border-radius: 3px; }
        
        #authStatus { font-size: 12px; font-weight: bold; color: #666; float: right; margin-top: -30px; }

        .running-footer {
            position: fixed; bottom: 0; left: 0; width: 100%;
            background: #004d40; color: #fff;
            padding: 10px 0; font-size: 14px; font-weight: bold;
            z-index: 1000; box-shadow: 0 -2px 10px rgba(0,0,0,0.2);
        }
    </style>
</head>
<body>
    <button class="back" onclick="goBack()">‚¨Ö Kembali</button>
    <div id="authStatus">Status Auth: Memeriksa...</div>
    <h2>‚öôÔ∏è Atur Kode Akses</h2>

    <!-- AREA DIAGNOSIS DATABASE -->
    <div class="card" style="border-left: 5px solid #ff9800;">
        <h3>üõ† Cek Koneksi Database</h3>
        <p style="font-size: 12px; color: #666;">Isi nama collection sesuai database Firebase Anda (contoh: siswa / students).</p>
        
        <div style="display: flex; gap: 10px;">
            <div style="flex: 1;">
                <label>Nama Collection:</label>
                <input type="text" id="inputColl" value="siswa" placeholder="cth: siswa">
            </div>
            <div style="flex: 1;">
                <label>Nama Field Kelas:</label>
                <input type="text" id="inputField" value="kelas" placeholder="cth: kelas">
            </div>
        </div>
        <button class="btn-check" onclick="loadDaftarKelas()">üîÑ MUAT DATA DARI FIREBASE</button>
        
        <div id="debugLog"></div>
    </div>

    <!-- AREA INPUT UTAMA -->
    <div class="card">
        <h3>1. Buat Kode Baru</h3>
        <label>Pilih Kelas:</label>
        <select id="pilihKelas"><option value="">-- Klik Tombol Oranye di Atas Dulu --</option></select>

        <label>Set Kode Akses Unik:</label>
        <input type="text" id="inputKode" placeholder="Contoh: XIPA1" onkeyup="this.value = this.value.toUpperCase()">
        <button onclick="simpanKode()">üíæ SIMPAN KODE</button>
    </div>

    <div class="card">
        <h3>2. Daftar Kode Aktif</h3>
        <table id="tabelData"></table>
    </div>

    <div class="running-footer">
        <marquee direction="left" scrollamount="6">
            &copy; Layanan Digital By Halil Budiyanto, S.Kom.I
        </marquee>
    </div>

    <script>
        // --- CONFIG FIREBASE (PASTIKAN SUDAH BENAR) ---
  const firebaseConfig = {
      apiKey: "AIzaSyBWNPcSAzQ_DC5bgXMfC6A3e2QkNMBmimw",
      authDomain: "sapamanusa.firebaseapp.com",
      projectId: "sapamanusa",
      storageBucket: "sapamanusa.firebasestorage.app",
      messagingSenderId: "1018203726618",
      appId: "1:1018203726618:web:e1715826ad005680c242a3"
  };
        
        // Inisialisasi
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        function goBack() { try { window.location.href = "./admin_menu.html"; } catch(e) { alert("Back Error"); } }

        window.onload = async () => {
            // Cek Admin di Session Storage
            try { if(sessionStorage.getItem('isAdmin') !== 'true') window.location.href="./index.html"; } catch(e){}
            
            // Monitor Status Auth
            auth.onAuthStateChanged(user => {
                const statusEl = document.getElementById('authStatus');
                if (user) {
                    statusEl.innerText = "Status Auth: ‚úÖ Terhubung (Anonymous)";
                    statusEl.style.color = "green";
                    setupRealtimeListener(); // Load data tabel kode
                } else {
                    statusEl.innerText = "Status Auth: ‚ùå Belum Login";
                    statusEl.style.color = "red";
                    // Coba login lagi
                    auth.signInAnonymously().catch(e => console.error(e));
                }
            });
        };

        // --- FUNGSI LOAD KELAS DENGAN DIAGNOSA ---
        async function loadDaftarKelas() {
            const select = document.getElementById('pilihKelas');
            const debugLog = document.getElementById('debugLog');
            
            let collName = document.getElementById('inputColl').value.trim() || 'siswa';
            let fieldName = document.getElementById('inputField').value.trim() || 'kelas';

            debugLog.style.display = 'block';
            debugLog.innerHTML = `‚è≥ Mencoba membaca collection: <span class="code-snippet">${collName}</span>...`;
            debugLog.style.color = "#fff"; // Reset warna default log
            select.innerHTML = '<option>Sedang memuat...</option>';

            try {
                // Ambil data
                const snap = await db.collection(collName).limit(50).get(); 
                
                if (snap.empty) {
                    debugLog.innerHTML += `<br>‚ùå GAGAL: Collection '${collName}' kosong atau tidak ditemukan.`;
                    select.innerHTML = '<option>Data Kosong</option>';
                    return;
                }

                debugLog.innerHTML += `<br>‚úÖ KONEKSI SUKSES! Ditemukan ${snap.size} dokumen data siswa.`;
                debugLog.innerHTML += `<br>üîç Mencari field kelas bernama: <span class="code-snippet">${fieldName}</span>...`;

                let kelasUnik = new Set();
                let fieldFound = false;

                snap.forEach(doc => { 
                    const data = doc.data();
                    if (data[fieldName]) {
                        kelasUnik.add(data[fieldName]);
                        fieldFound = true;
                    }
                });

                if (!fieldFound) {
                    debugLog.innerHTML += `<br>‚ùå GAGAL: Field '${fieldName}' tidak ditemukan di data siswa.<br>Coba cek nama kolom di Firebase (misal: 'rombel' atau 'class').`;
                    select.innerHTML = '<option>Kolom Salah</option>';
                    return;
                }

                // Sukses
                debugLog.innerHTML += `<br>‚úÖ BERHASIL! Ditemukan ${kelasUnik.size} nama kelas unik.`;
                debugLog.style.color = "#00e676"; // Warna hijau sukses
                
                select.innerHTML = '<option value="">-- Pilih Kelas --</option>';
                Array.from(kelasUnik).sort().forEach(k => {
                    select.innerHTML += `<option value="${k}">${k}</option>`;
                });

            } catch(e) { 
                // PENANGANAN ERROR KHUSUS
                debugLog.style.color = "#ff5252";
                debugLog.innerHTML += `<br><br>‚õî <b>ERROR: ${e.code} - ${e.message}</b>`;
                
                if(e.code === 'permission-denied' || e.message.includes("permission")) {
                    debugLog.innerHTML += `
                        <br><br>üëâ <b>SOLUSI WAJIB DILAKUKAN DI FIREBASE CONSOLE:</b>
                        <br>1. Buka <b>Authentication</b> > Tab <b>Sign-in method</b> > Aktifkan <b>Anonymous</b>.
                        <br>2. Buka <b>Firestore Database</b> > Tab <b>Rules</b>.
                        <br>3. Ubah Rules menjadi (Untuk sementara):
                        <br><span class="code-snippet">allow read, write: if true;</span>
                        <br>4. Klik <b>Publish</b> dan coba lagi tombol ini.
                    `;
                }
            }
        }

        async function simpanKode() {
            const kelas = document.getElementById('pilihKelas').value;
            const kode = document.getElementById('inputKode').value.trim();
            if(!kelas || !kode) return alert("Lengkapi data!");
            
            try {
                const cek = await db.collection('akses_kelas').where('kode','==',kode).get();
                if(!cek.empty) return alert("Kode sudah dipakai!");

                await db.collection('akses_kelas').doc(kelas.replace(/\s+/g,'_')).set({
                    nama_kelas: kelas, kode: kode, updated: firebase.firestore.FieldValue.serverTimestamp()
                });
                alert("Tersimpan!"); document.getElementById('inputKode').value = "";
            } catch(e) {
                alert("Gagal Simpan: " + e.message);
            }
        }

        function setupRealtimeListener() {
            db.collection('akses_kelas').onSnapshot(snap => {
                let html = "<tr><th>Kelas</th><th>Kode</th><th>Aksi</th></tr>";
                snap.forEach(doc => {
                    const d = doc.data();
                    html += `<tr><td><b>${d.nama_kelas}</b></td><td><span class="badge">${d.kode}</span></td><td><button style="width:auto; padding:5px; background:red; margin:0;" onclick="hapus('${doc.id}')">Hapus</button></td></tr>`;
                });
                document.getElementById('tabelData').innerHTML = html;
            }, error => {
                console.error("Error listener:", error);
                // Jika error permission di listener tabel
                if(error.code === 'permission-denied') {
                    document.getElementById('tabelData').innerHTML = "<tr><td colspan='3' style='color:red'>Izin Ditolak: Cek Rules Firebase Anda.</td></tr>";
                }
            });
        }

        window.hapus = async (id) => { if(confirm("Hapus?")) await db.collection('akses_kelas').doc(id).delete(); }
    </script>
</body>
</html>
```

### Cara Memperbaiki Error "Missing Permissions" (Manual)

Jika error masih muncul setelah ganti kode, Anda wajib melakukan ini di **Firebase Console**:

1.  **Aktifkan Login Anonim (Anonymous Auth):**
    * Buka Firebase Console > Menu **Authentication**.
    * Klik tab **Sign-in method**.
    * Klik **Anonymous** -> Ubah jadi **Enable** -> Simpan.

2.  **Perbaiki Firestore Rules:**
    * Buka Firebase Console > Menu **Firestore Database**.
    * Klik tab **Rules**.
    * Ganti kodenya menjadi seperti ini (Paling Longgar, hanya untuk tes):
        ```text
        rules_version = '2';
        service cloud.firestore {
          match /databases/{database}/documents {
            match /{document=**} {
              allow read, write: if true;
            }
          }
        }