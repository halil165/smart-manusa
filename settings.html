<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Atur Kode</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <style>
        body { font-family: sans-serif; background: #f4f6f8; padding: 20px; max-width: 800px; margin: auto; padding-bottom: 60px; }
        .card { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 20px; }
        label { font-weight: bold; display: block; margin-top: 10px; }
        select, input { width: 100%; padding: 10px; margin-top: 5px; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box; }
        button { width: 100%; padding: 12px; background: #00695c; color: white; border: none; border-radius: 5px; margin-top: 15px; cursor: pointer; font-weight: bold; }
        button:hover { background: #004d40; }
        button.back { background: #6c757d; width: auto; margin-bottom: 10px;}
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { padding: 10px; border-bottom: 1px solid #eee; text-align: left; }
        th { background: #e0f2f1; color: #00695c;}
        .badge { background: #ffab00; color: #000; padding: 2px 8px; border-radius: 10px; font-size: 12px; font-weight: bold; }

        .running-footer {
            position: fixed; bottom: 0; left: 0; width: 100%;
            background: #004d40; color: #fff;
            padding: 10px 0; font-size: 14px; font-weight: bold;
            z-index: 1000; box-shadow: 0 -2px 10px rgba(0,0,0,0.2);
        }
    </style>
</head>
<body>
    <button class="back" onclick="goBack()">‚¨Ö Kembali</button>
    <h2>‚öôÔ∏è Atur Kode Akses</h2>

    <div class="card">
        <h3>1. Buat Kode Baru</h3>
        <label>Pilih Kelas (Dari Database Siswa):</label>
        <select id="pilihKelas"><option>Loading...</option></select>
        <label>Set Kode Akses Unik:</label>
        <input type="text" id="inputKode" placeholder="Contoh: XIPA1" onkeyup="this.value = this.value.toUpperCase()">
        <button onclick="simpanKode()">üíæ SIMPAN KODE</button>
    </div>

    <div class="card">
        <h3>2. Daftar Kode Aktif</h3>
        <table id="tabelData"></table>
    </div>

    <div class="running-footer">
        <marquee direction="left" scrollamount="6">
            &copy; Layanan Digital By Halil Budiyanto, S.Kom.I
        </marquee>
    </div>

    <script>
        // --- CONFIG FIREBASE (WAJIB GANTI) ---
  const firebaseConfig = {
      apiKey: "AIzaSyBWNPcSAzQ_DC5bgXMfC6A3e2QkNMBmimw",
      authDomain: "sapamanusa.firebaseapp.com",
      projectId: "sapamanusa",
      storageBucket: "sapamanusa.firebasestorage.app",
      messagingSenderId: "1018203726618",
      appId: "1:1018203726618:web:e1715826ad005680c242a3"
  };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        function goBack() { try { window.location.href = "./admin_menu.html"; } catch(e) { alert("Back Error"); } }

        window.onload = async () => {
            try { if(sessionStorage.getItem('isAdmin') !== 'true') window.location.href="./index.html"; } catch(e){}
            
            const select = document.getElementById('pilihKelas');
            try {
                const snap = await db.collection('siswa').get(); 
                let kelasUnik = new Set();
                snap.forEach(doc => { if(doc.data().kelas) kelasUnik.add(doc.data().kelas); });
                
                select.innerHTML = '<option value="">-- Pilih Kelas --</option>';
                Array.from(kelasUnik).sort().forEach(k => {
                    select.innerHTML += `<option value="${k}">${k}</option>`;
                });
            } catch(e) { select.innerHTML = '<option>Gagal load database siswa</option>'; }

            db.collection('akses_kelas').onSnapshot(snap => {
                let html = "<tr><th>Kelas</th><th>Kode</th><th>Aksi</th></tr>";
                snap.forEach(doc => {
                    const d = doc.data();
                    html += `<tr><td><b>${d.nama_kelas}</b></td><td><span class="badge">${d.kode}</span></td><td><button style="width:auto; padding:5px; background:red; margin:0;" onclick="hapus('${doc.id}')">Hapus</button></td></tr>`;
                });
                document.getElementById('tabelData').innerHTML = html;
            });
        };

        async function simpanKode() {
            const kelas = document.getElementById('pilihKelas').value;
            const kode = document.getElementById('inputKode').value.trim();
            if(!kelas || !kode) return alert("Lengkapi data!");
            
            const cek = await db.collection('akses_kelas').where('kode','==',kode).get();
            if(!cek.empty) return alert("Kode sudah dipakai!");

            await db.collection('akses_kelas').doc(kelas.replace(/\s+/g,'_')).set({
                nama_kelas: kelas, kode: kode, updated: firebase.firestore.FieldValue.serverTimestamp()
            });
            alert("Tersimpan!"); document.getElementById('inputKode').value = "";
        }

        window.hapus = async (id) => { if(confirm("Hapus?")) await db.collection('akses_kelas').doc(id).delete(); }
    </script>
</body>
</html>