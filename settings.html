<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Atur Kode</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script> 
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <style>
        body { font-family: sans-serif; background: #f4f6f8; padding: 20px; max-width: 800px; margin: auto; padding-bottom: 60px; }
        .card { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 20px; }
        label { font-weight: bold; display: block; margin-top: 10px; font-size: 14px; color: #555; }
        select, input { width: 100%; padding: 10px; margin-top: 5px; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box; }
        button { width: 100%; padding: 12px; background: #00695c; color: white; border: none; border-radius: 5px; margin-top: 15px; cursor: pointer; font-weight: bold; }
        button.back { background: #6c757d; width: auto; margin-bottom: 10px;}
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { padding: 10px; border-bottom: 1px solid #eee; text-align: left; }
        th { background: #e0f2f1; color: #00695c;}
        .badge { background: #ffab00; color: #000; padding: 2px 8px; border-radius: 10px; font-size: 12px; font-weight: bold; }
        .running-footer { position: fixed; bottom: 0; left: 0; width: 100%; background: #004d40; color: #fff; padding: 10px 0; font-size: 14px; font-weight: bold; z-index: 1000; }
    </style>
</head>
<body>
    <button class="back" onclick="goBack()">‚¨Ö Kembali</button>
    <div id="authStatus" style="float:right; font-size:12px; font-weight:bold; color:#666;">Auth...</div>
    <h2>‚öôÔ∏è Atur Kode Akses</h2>

    <div class="card">
        <h3>1. Buat Kode Baru</h3>
        <label>Pilih Kelas (Dari Master Data):</label>
        <select id="pilihKelas"><option value="">-- Menunggu Database... --</option></select>

        <label>Set Kode Akses Unik:</label>
        <input type="text" id="inputKode" placeholder="Contoh: XIPA1" onkeyup="this.value = this.value.toUpperCase()">
        <button onclick="simpanKode()">üíæ SIMPAN KODE</button>
    </div>

    <div class="card">
        <h3>2. Daftar Kode Aktif</h3>
        <table id="tabelData"></table>
    </div>

    <div class="running-footer">
        <marquee direction="left" scrollamount="6">
            &copy; Layanan Digital By Halil Budiyanto, S.Kom.I
        </marquee>
    </div>

    <script>
        // --- CONFIG FIREBASE ---
  const firebaseConfig = {
      apiKey: "AIzaSyBWNPcSAzQ_DC5bgXMfC6A3e2QkNMBmimw",
      authDomain: "sapamanusa.firebaseapp.com",
      projectId: "sapamanusa",
      storageBucket: "sapamanusa.firebasestorage.app",
      messagingSenderId: "1018203726618",
      appId: "1:1018203726618:web:e1715826ad005680c242a3"
  };
        
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        function goBack() { try { window.location.href = "./admin_menu.html"; } catch(e) { alert("Back Error"); } }

        window.onload = async () => {
            try { if(sessionStorage.getItem('isAdmin') !== 'true') window.location.href="./index.html"; } catch(e){}
            
            auth.onAuthStateChanged(user => {
                const st = document.getElementById('authStatus');
                if(user) {
                    st.innerText = "‚úÖ Connected"; st.style.color = "green";
                    loadDaftarKelas();
                    setupRealtimeListener();
                } else {
                    st.innerText = "üîÑ Connecting...";
                    auth.signInAnonymously().catch(e => alert("Auth Error: " + e.message));
                }
            });
        };

        // --- LOAD KELAS (DARI COLLECTION 'master_siswa') ---
        async function loadDaftarKelas() {
            const select = document.getElementById('pilihKelas');
            select.innerHTML = '<option>Sedang memuat...</option>';

            try {
                // Ambil semua dokumen di 'master_siswa'
                // ID Dokumen = Nama Kelas (Sesuai upload_siswa.html Anda)
                const snap = await db.collection('master_siswa').get(); 
                
                if (snap.empty) {
                    select.innerHTML = '<option>Data Kosong</option>';
                    return;
                }

                let kelasList = [];
                snap.forEach(doc => {
                    kelasList.push(doc.id); // doc.id adalah Nama Kelas (misal: X TE A)
                });

                select.innerHTML = '<option value="">-- Pilih Kelas --</option>';
                kelasList.sort().forEach(k => {
                    let opt = document.createElement('option');
                    opt.value = k; 
                    opt.text = k;
                    select.add(opt);
                });

            } catch(e) { 
                alert("Gagal Load Kelas: " + e.message);
                select.innerHTML = '<option>Error Koneksi</option>';
            }
        }

        async function simpanKode() {
            const kelas = document.getElementById('pilihKelas').value;
            const kode = document.getElementById('inputKode').value.trim();
            if(!kelas || !kode) return alert("Pilih Kelas dan isi Kode!");
            
            try {
                const cek = await db.collection('akses_kelas').where('kode','==',kode).get();
                if(!cek.empty) return alert("Kode sudah dipakai!");

                await db.collection('akses_kelas').doc(kelas.replace(/\s+/g,'_')).set({
                    nama_kelas: kelas, 
                    kode: kode, 
                    updated: firebase.firestore.FieldValue.serverTimestamp()
                });
                alert("‚úÖ Kode Berhasil Disimpan!"); 
                document.getElementById('inputKode').value = "";
            } catch(e) {
                alert("Gagal Simpan: " + e.message);
            }
        }

        function setupRealtimeListener() {
            db.collection('akses_kelas').onSnapshot(snap => {
                let html = "<tr><th>Kelas</th><th>Kode</th><th>Aksi</th></tr>";
                snap.forEach(doc => {
                    const d = doc.data();
                    html += `<tr><td><b>${d.nama_kelas}</b></td><td><span class="badge">${d.kode}</span></td><td><button style="width:auto; padding:5px; background:red; margin:0;" onclick="hapus('${doc.id}')">Hapus</button></td></tr>`;
                });
                document.getElementById('tabelData').innerHTML = html;
            });
        }

        window.hapus = async (id) => { if(confirm("Hapus?")) await db.collection('akses_kelas').doc(id).delete(); }
    </script>
</body>
</html>